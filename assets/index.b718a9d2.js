var e=Object.assign;import{r as t,s as n,f as o,o as r,l as c,i,a,b as l,c as s,d,v as u,e as h,g as m,t as p,m as g,h as f,j as b,k as E,n as v}from"./vendor.fe0391b0.js";!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const o=new URL(e,location),r=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,c)=>{const i=new URL(e,o);if(self[t].moduleMap[i])return n(self[t].moduleMap[i]);const a=new Blob([`import * as m from '${i}';`,`${t}.moduleMap['${i}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){c(new Error(`Failed to import: ${e}`)),r(l)},onload(){n(self[t].moduleMap[i]),r(l)}});document.head.appendChild(l)})),self[t].moduleMap={}}}("/tsmind/assets/");const x=t.createContext({root:null,setRoot:e=>{}}),C=20,M=20,w=10,y=5,R=5;function $(e){return{padding:`${y}px ${w}px`}}function k(t){const o=new DocumentFragment;function r(e){const t=document.createElement("span");return t.setAttribute("style",`position: absolute; visibility: hidden; user-select: none; ${Object.entries($()).map((([e,t])=>`${e}: ${t}`)).join(";")}`),t.innerText=e.label,o.appendChild(t),t}const c=function t(n){const o=n.children.map(t),c=r(n);return e(e({},n),{children:o,coord:[0,0],size:()=>{const e=[c.clientWidth,c.clientHeight];return c.remove(),e}})}(t);return document.body.appendChild(o),function t(o){const r=o.children.map(t),c=o.size(),i=Math.max(c[1],C*(r.length-1)+n(r,"height"));return e(e({},o),{size:c,height:i,children:r})}(c)}function z(t){const n=n=>function(t,n){return function t(o){let r=0;for(const e of o.children)e.coord=[o.coord[0]+(o.size[0]/2+M+e.size[0]/2)*("left"===n?-1:1),o.coord[1]+r-o.height/2+e.height/2],r+=e.height+C;return e(e({},o),{children:o.children.map(t)})}(k(t))}(e(e({},t),{children:t.children.filter((e=>e.direction===n))}),n),o=n("right");return e(e({},o),{children:o.children.concat(n("left").children)})}function S(e,t=!1,n=""){return{root:t,id:Math.random().toString(36).slice(2),label:n,direction:e,expanded:!0,children:[]}}function D(e,t){return[e[0]-t[0],e[1]-t[1]]}const j=function(e,t){return[e[0]+t[0],e[1]+t[1]]};function B(e){return`${e[0]},${e[1]}`}const L=t.memo((function(e){const{a:n,b:o}=e,r=Math.min(n[1],o[1]),c=Math.min(n[0],o[0]),i=Math.max(Math.abs(n[0]-o[0]),1),a=Math.max(Math.abs(n[1]-o[1]),1),l=[c,r],s=[o[0]-c,n[1]-r],d=[n[0]-c,o[1]-r];return t.createElement("svg",{viewBox:`0 0 ${i} ${a}`,style:{position:"absolute",zIndex:-1,top:r,left:c,width:i,height:a}},t.createElement("path",{d:`M${B(D(n,l))} C${B(s)} ${B(d)} ${B(D(o,l))}`,fill:"transparent",stroke:"black"}))})),O=t.memo((function(e){const{parent:n,child:o}=e;return t.createElement(L,{a:n.coord,b:j(o.coord,[(R-o.size[0]/2)*("left"===o.direction?-1:1),0])})})),U=new Set;o(document,"mousemove"),o(document,"mouseup");const A=t.memo((function(n){const{node:o,editing:r}=n,[c,i]=t.useState(o.label.length),a=t.useRef(null);o.coord[0],o.size[0],o.coord[1],o.size[1];const l=e(e({},$()),{height:o.size[1],border:"1px solid black",borderRadius:"5px",lineHeight:`${o.size[1]}px`,backgroundColor:"white"});return t.useLayoutEffect((()=>{const e=document.getSelection();if(r&&e&&a.current){const t=new Range,n=Array.from(a.current.childNodes).find((e=>e.nodeValue));n&&(null==t||t.setStart(n,c),null==t||t.setEnd(n,c),e.removeAllRanges(),e.addRange(t))}}),[c,r]),t.createElement("div",{ref:a,className:"node",contentEditable:r,style:l,suppressContentEditableWarning:!0,onBlur:n.onBlur,onInput:t=>{var r,c;i(null!=(c=null==(r=window.getSelection())?void 0:r.getRangeAt(0).startOffset)?c:0),n.onChange(e(e({},o),{label:t.currentTarget.innerText}))}},o.label||" ")})),F=t.memo((function(e){const{node:n,path:o,getCoord:u}=e,[h,m]=t.useState(U.has(n.id)),p=t.useCallback((()=>m(!1)),[]),{root:g,setRoot:f}=t.useContext(x);t.useEffect((()=>{U.delete(n.id)}),[]);let b=n.coord,[E,v]=[b[0]-n.size[0]/2,b[1]-n.size[1]/2];return t.createElement(t.Fragment,null,n.children.map(((o,r)=>t.createElement("div",{key:o.id},t.createElement(O,{parent:n,child:o}),t.createElement(F,{startDragging:e.startDragging,getCoord:e.getCoord,node:o,path:e.path.concat("children",r)})))),t.createElement("div",{className:"node-wrap",style:{position:"absolute",top:v,left:E},onKeyPressCapture:e=>{if("Enter"===e.key)if(e.preventDefault(),h)m(!1);else if(e.shiftKey)!function(){const e=S(n.direction);U.add(e.id),f(r(c(o.concat("children")),d(e),g))}();else{if(function(e){return!!e.root}(n))return;const e=S(n.direction);U.add(e.id),f(r(c(i(o)),a(l(o),e),g))}},tabIndex:-1,onMouseDown:t=>{const o=D(n.coord,u(t.clientX,t.clientY));e.startDragging(e.path,((e,t)=>j(u(e,t),o)))},onDoubleClick:()=>{h||m(!0)}},t.createElement(A,{editing:h,node:n,onBlur:p,onChange:function(e){f(s(o,e,g))}})))}));function I(e){const{root:n}=e,o=t.useRef(null),r=t.useCallback(((e,t)=>{const{left:n,top:r}=o.current.getBoundingClientRect();return[e-n-300,t-r-300]}),[]);return t.createElement("div",{ref:o,style:{width:600,height:600}},t.createElement("div",{style:{transform:"translate(300px, 300px)"}},t.createElement(F,{node:n,path:[],getCoord:r,startDragging:e.startDragging}),e.dragSource&&t.createElement(F,{node:e.dragSource,path:[],getCoord:r,startDragging:e.startDragging})))}const N={label:"Root",id:"root",expanded:!0,direction:"right",children:[{label:"sup2",id:"sub2",direction:"right",expanded:!1,children:[{label:"sub4",id:"sub4",direction:"right",expanded:!1,children:[]},{label:"sub3",id:"sub3",direction:"right",expanded:!1,children:[]}]},{label:"sub5",id:"sub5",direction:"right",expanded:!1,children:[]},{label:"sub1",id:"sub1",direction:"left",expanded:!1,children:[]}]};function _(e,t){let n={value:-1/0,path:void 0};return function e(o,r){const c=-function(e,t){const n=D(e,t);return Math.abs(n[0])+Math.abs(n[1])}(t,o.coord);console.log(o.id,t,o.coord),c>n.value&&t[0]-o.coord[0]>M&&(n={value:c,path:r.concat(["children",0])}),o.children.forEach(((t,n)=>e(t,r.concat(["children",n]))))}(e,[]),console.log(n),n.path}const P=o(document,"mousemove"),T=o(document,"mouseup");let H,K=[],W=[];function X(){const[n,o]=t.useState(N),[s,d]=t.useState(),v=t.useMemo((()=>z(n)),[n]);H=v;const C=t.useCallback(((t,n)=>{console.log(t);const s=c(t),x=i(t),C=l(t),M=u(s,v);d(M);const w=h(P.pipe(p(T),g((e=>n(e.clientX,e.clientY)))),m(void 0));w.subscribe((t=>{console.warn(t),t&&d((n=>e(e({},n),{coord:t})))})),w.pipe(f((e=>!!e)),g((e=>_(H,e))),b()).subscribe((e=>{console.log(e),o(e?t=>r(c(i(e)),a(l(e),M),t):e=>(console.log(e.children),r(c(x),a(C,M),e))),d(void 0)})),o((e=>r(c(x),E(C,1),e)))}),[v]);return t.createElement(x.Provider,{value:{root:n,setRoot:o}},t.createElement("div",{className:"App"},t.createElement("button",{onClick:function(){const e=K.pop();e&&(W.push(n),o(e))}},"undo"),t.createElement("button",{onClick:function(){const e=W.pop();e&&(K.push(n),o(e))}},"redo"),t.createElement(I,{startDragging:C,root:v,onChange:function(e){K.push(n),W=[],o(e)},dragSource:s&&e(e({},s),{children:[]})})))}v.render(t.createElement(t.StrictMode,null,t.createElement(X,null)),document.getElementById("root"));
