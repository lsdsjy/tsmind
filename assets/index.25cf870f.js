var e=Object.assign;import{r as t,f as n,s as r,o,l as i,a as c,i as a,b as l,c as s,d,p as u,e as p,t as m,g as h,h as f,j as g,k as b,m as x,u as v,n as w,q as E,v as C,w as y,x as M,y as $}from"./vendor.4730c5ea.js";!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const r=new URL(e,location),o=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,i)=>{const c=new URL(e,r);if(self[t].moduleMap[c])return n(self[t].moduleMap[c]);const a=new Blob([`import * as m from '${c}';`,`${t}.moduleMap['${c}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){i(new Error(`Failed to import: ${e}`)),o(l)},onload(){n(self[t].moduleMap[c]),o(l)}});document.head.appendChild(l)})),self[t].moduleMap={}}}("/tsmind/assets/");const k=t.createContext({canvas:null,setCanvas:e=>{}}),z=20,R=20,S=10,D=5,N=8,P=5,B=[600,600];function T(t={}){const{label:n="New Node",direction:r="right"}=t;return e({root:t.root,id:Math.random().toString(36).slice(2),label:n,direction:r,expanded:!0,children:[],summaries:[]},t.root?{coord:t.coord}:{})}const L=t.createContext({startDragging:()=>{}});n(document,"mousedown");const Y=n(document,"mousemove"),j=n(document,"mouseup");function O(e){return e.reduce(((e,t)=>{return n=e,r=t,{top:Math.min(n.top,r.top),left:Math.min(n.left,r.left),bottom:Math.max(n.bottom,r.bottom),right:Math.max(n.right,r.right)};var n,r}),{top:1/0,left:1/0,right:-1/0,bottom:-1/0})}function W(t){return e({position:"absolute",padding:`${D}px ${S}px`,border:"1px solid black",boxSizing:"border-box",borderRadius:"5px",backgroundColor:"white"},t.fixedWidth?{maxWidth:`${t.fixedWidth}px`,width:`${t.fixedWidth}px`,overflowWrap:"break-word",whiteSpace:"break-spaces"}:{whiteSpace:"nowrap"})}const F=new WeakMap;function X(t){if(F.has(t))return F.get(t);const n=new DocumentFragment;const o=function t(r){const o=r.children.map(r.expanded?t:function t(n){return e(e({coord:[0,0]},n),{children:n.children.map(t),size:()=>[0,0]})}),i=function(e){const t=document.createElement("span");return t.setAttribute("style","visibility: hidden;"),Object.assign(t.style,W(e)),t.innerText=e.label,n.appendChild(t),t}(r);return e(e({coord:[0,0]},r),{children:o,size:()=>{const{width:e,height:t}=i.getBoundingClientRect(),n=[e,t];return i.remove(),n}})}(t);document.body.appendChild(n);const i=function t(n){const o=n.children.map(n.expanded?t:function t(n){return e(e({},n),{size:n.size(),height:0,children:n.children.map(t)})}),i=n.size(),c=Math.max(i[1],z*(o.length-1)+r(o,"height"));return e(e({},n),{size:i,height:c,children:o})}(o);return F.set(t,i),i}function A(t){const n=n=>function(t,n){function r(t){return e(e({},t),{children:t.children.map(r),summaries:[]})}return function t(o){let i=0,c={top:o.coord[1]-o.size[1]/2-N,bottom:o.coord[1]+o.size[1]/2+N,left:o.coord[0]-o.size[0]/2-N,right:o.coord[0]+o.size[0]/2+N};if(!o.expanded)return{node:e(e({},o),{children:o.children.map(r),summaries:[]}),rect:c};for(const e of o.children)e.coord=[o.coord[0]+(o.size[0]/2+R+e.size[0]/2)*("left"===n?-1:1),o.coord[1]+i-o.height/2+e.height/2],i+=e.height+z;let a=o.children.map(t),l=a.map(((t,n)=>e(e({},t.node),{summaries:o.children[n].summaries.map(((t,n)=>e(e({},t),{rect:O(a.slice(n,n+t.count).map((e=>e.rect)))})))})));return c=O([c].concat(a.map((e=>e.rect)))),{node:e(e({},o),{children:l,summaries:o.summaries.map((t=>e(e({},t),{rect:c})))}),rect:c}}(X(t)).node}(e(e({},t),{children:t.children.filter((e=>e.direction===n))}),n),r=n("right");return e(e({},r),{children:r.children.concat(n("left").children)})}function I(e){return{children:e.children.map(A)}}function U(e){return c(e,(e=>["children",e]))}function _(e){return t=U(e),[l(t),s(t)];var t}function q(e,t,n){return o(i(U(t)),n,e)}function H(e,t,n){const[r,c]=_(t);return o(i(r),a(c,n),e)}function K(e,t,n){return q(e,t,(()=>n))}function V(e,t){const[n,r]=_(t);return o(i(n),p(r,1),e)}function G(e,t){return[e[0]-t[0],e[1]-t[1]]}function J(e,t){const n=G(e,t);return Math.abs(n[0])+Math.abs(n[1])}const Q=function(e,t){return[e[0]+t[0],e[1]+t[1]]};function Z(e){return`${e[0]},${e[1]}`}const ee=t.memo((function(e){const{a:n,b:r}=e,o=Math.min(n[1],r[1]),i=Math.min(n[0],r[0]),c=Math.max(Math.abs(n[0]-r[0]),1),a=Math.max(Math.abs(n[1]-r[1]),1),l=[i,o],s=[r[0]-i,n[1]-o],d=[n[0]-i,r[1]-o];return t.createElement("svg",{viewBox:`0 0 ${c} ${a}`,style:{position:"absolute",zIndex:-1,top:o,left:i,width:c,height:a}},t.createElement("path",{d:`M${Z(G(n,l))} C${Z(s)} ${Z(d)} ${Z(G(r,l))}`,fill:"transparent",stroke:"black"}))})),te=function(e){const[n,r]=t.useState(!1);return t.createElement("span",{style:{opacity:Number(!e.expanded||n),position:"absolute",left:e.coord[0],top:e.coord[1],fontSize:"0.8rem",transform:"translate(-50%, -50%)",border:"solid 1px black",borderRadius:"1000px",width:"12px",height:"12px",backgroundColor:n?"gray":"white",lineHeight:"12px",textAlign:"center",userSelect:"none",cursor:"pointer",transition:n?"opacity .3s ease":""},onClick:e.toggle,onMouseOver:()=>r(!0),onMouseOut:()=>r(!1)},e.expanded?"-":e.count)},ne=t.memo((function(e){const{parent:n}=e,{children:r}=n,o=n.root||!n.children.length?n.coord:[n.coord[0]+n.size[0]/2+10,n.coord[1]];return t.createElement(t.Fragment,null,n.root||t.createElement(t.Fragment,null,t.createElement(ee,{a:n.coord,b:o}),t.createElement(te,{coord:o,expanded:n.expanded,count:n.children.length,toggle:e.toggle})),n.expanded&&r.map(((e,n)=>t.createElement(ee,{key:n,a:o,b:Q(e.coord,[(P-e.size[0]/2)*("left"===e.direction?-1:1),0])}))))})),re=new Set,oe=t.memo((function(n){const{node:r,editing:o}=n,[i,c]=t.useState(r.label.length),a=t.useRef(!1),l=t.useRef(null);function s(t){var o,i;c(null!=(i=null==(o=window.getSelection())?void 0:o.getRangeAt(0).startOffset)?i:0),n.onChange(e(e({},r),{label:t}))}return t.useLayoutEffect((()=>{const e=document.getSelection();if(o&&e&&l.current){const t=new Range,n=Array.from(l.current.childNodes).find((e=>e.nodeValue));n&&(null==t||t.setStart(n,i),null==t||t.setEnd(n,i),e.removeAllRanges(),e.addRange(t))}}),[i,o]),t.createElement("div",{ref:l,className:"editor",contentEditable:o,suppressContentEditableWarning:!0,onBlur:n.onBlur,onInput:e=>{a.current||s(e.currentTarget.innerText)},onCompositionStart:()=>{a.current=!0},onCompositionEnd:e=>{a.current=!1,s(e.currentTarget.innerText)}},r.label||" ")})),ie=t.memo((function(n){let{node:r,path:c,getCoord:a}=n;const[l,s]=t.useState(re.has(r.id)),u=t.useCallback((()=>s(!1)),[]),{canvas:p,setCanvas:f}=t.useContext(k),{startDragging:g}=t.useContext(L),b=t.useRef(null);function x(e){f(K(p,c,e))}function v(){const t=T({direction:r.direction});re.add(t.id);const n=K(p,c,e(e({},r),{expanded:!0}));f(function(e,t,n){return o(i(U(t).concat("children")),d(n),e)}(n,c,t))}t.useEffect((()=>{re.delete(r.id)}),[]),r=e(e({},r),{expanded:r.expanded||r.children.some((e=>e.dropPreview))});const[w,E]=G(r.coord,(C=r.size,y=.5,[C[0]*y,C[1]*y]));var C,y;const M=e(e({},W(r)),{display:"flex",alignItems:"center",top:E,left:w,width:r.size[0],height:r.size[1]});return t.createElement(t.Fragment,null,t.createElement(ne,{parent:r,toggle:()=>{x(e(e({},r),{expanded:!r.expanded}))}}),r.expanded&&r.children.map(((e,n)=>t.createElement("div",{key:e.id,className:e.dropPreview?"drop-preview":""},e.summaries.map(((l,s)=>{const{top:d,left:u,right:p,bottom:g}=l.rect;return t.createElement("div",{key:`${e.id}-${l.count}`,style:{position:"absolute",top:`${d}px`,left:`${u}px`,width:p-u+"px",height:g-d+"px",border:"solid 2px black",boxSizing:"border-box",userSelect:"none",zIndex:-100}},t.createElement("div",{style:{position:"absolute",bottom:"-2px",height:"5px",cursor:"s-resize",width:"100%"},onMouseDown:t=>{t.stopPropagation();const l=n,d=t.target.parentElement,u=a(0,t.clientY)[1],p=d.getBoundingClientRect().height;let g=a(0,t.clientY)[1];Y.pipe(m(j)).subscribe({next:e=>{d.style.height=`${a(0,e.clientY)[1]-u+p}px`,g=a(0,e.clientY)[1]},complete:()=>{const[,t]=a(0,g),n=r.children.filter((t=>t.direction===e.direction)),u=Math.max(l,h((e=>e.coord[1]<=t),n));d.style.height=`${p}px`,f((e=>q(e,[...c,l],o(i(["summaries",s,"count"]),(()=>u-l+1)))))}})}}),l.label)})),t.createElement(ie,{getCoord:a,node:e,path:[...c,n]})))),t.createElement("div",{ref:b,className:"node-wrap node",style:M,onKeyDown:e=>{if("Enter"===e.key)if(e.preventDefault(),l)s(!1),b.current.focus();else{if(function(e){return!!e.root}(r))return v();const e=T();re.add(e.id),f(H(p,c,e))}else"Tab"===e.key&&(e.preventDefault(),s(!1),v())},tabIndex:-1,onMouseDown:e=>{if(l)return;const t=G(r.coord,a(e.clientX,e.clientY));g(n.path,((e,n)=>Q(a(e,n),t)),[e.clientX,e.clientY])},onDoubleClick:e=>{l||(e.stopPropagation(),l||s(!0))}},t.createElement("div",{className:"resizer",onMouseDown:t=>{t.stopPropagation();const n=t.clientX,o=b.current.getBoundingClientRect().width;Y.pipe(m(j)).subscribe((t=>{const i=o+t.clientX-n;i<10||f((t=>K(t,c,e(e({},r),{fixedWidth:i}))))}))}}),t.createElement(oe,{editing:l,node:r,onBlur:u,onChange:x})))}));function ce(e){const{canvas:n}=e,{setCanvas:r}=t.useContext(k),c=t.useRef(null),[a,l]=B,s=t.useCallback(((e,t)=>{const{left:n,top:r}=c.current.getBoundingClientRect();return console.log(c.current.scrollLeft,c.current.scrollTop),[e-n-a/2+c.current.scrollLeft/1.5,t-r-l/2+c.current.scrollTop/1.5]}),[]);return t.createElement("div",{ref:c,style:{width:`${a}px`,height:`${l}px`,overflow:"scroll"},onDoubleClick:e=>{e.target===c.current&&(e.preventDefault(),r(o(i(["children"]),d(T({root:!0,label:"Free Node",coord:s(e.clientX,e.clientY)})))))}},t.createElement("div",{style:{width:`${a}px`,height:`${l}px`,transform:"scale(1.5)"}},t.createElement("div",{style:{transform:`translate(${a/2}px, ${l/2}px)`}},n.children.map(((e,n)=>t.createElement(ie,{key:e.id,node:e,path:[n],getCoord:s}))),n.dragSource&&!n.dropTarget&&t.createElement(ie,{node:n.dragSource,path:[],getCoord:s}))))}const ae={children:[{label:"Root",id:"root",expanded:!0,direction:"right",root:!0,coord:[0,0],summaries:[],children:[{label:"sup2",id:"sub2",direction:"right",expanded:!1,summaries:[{count:1,label:"summ"}],children:[{label:"sub4",id:"sub4",direction:"right",expanded:!1,children:[],summaries:[]},{label:"sub3",id:"sub3",direction:"right",expanded:!1,children:[],summaries:[]}]},{label:"sub5",id:"sub5",direction:"right",expanded:!1,children:[],summaries:[]},{label:"sub1",id:"sub1",direction:"left",expanded:!1,children:[],summaries:[]}]}]};function le(e,t){let n={value:-1/0,path:void 0};function r(e,o){const i=function(e,t){return-J(t,e.coord)}(e,t);i>n.value&&t[0]-e.coord[0]>R&&t[0]-e.coord[0]<100&&(n={value:i,path:[...o,0]}),e.children.filter((e=>!e.dropPreview)).forEach(((e,t)=>r(e,[...o,t])))}return e.children.filter((e=>!e.dropPreview)).forEach(((e,t)=>r(e,[t]))),n.path}let se=[],de=[];function ue(){var n;const r=t.useRef(ae),i=t.useMemo((()=>I(r.current)),[r.current]),c=t.useRef(),a=v();function s(e){r.current="function"==typeof e?e(r.current):e,a()}function p(e){c.current=e,a()}const h=t.useCallback(((t,n,a)=>{const s=function(e,t){return u(U(t),e)}(i,t);Y.pipe(m(j),w((e=>J([e.clientX,e.clientY],a)<10)),E((e=>n(e.clientX,e.clientY)))).pipe(((...e)=>t=>f(t.pipe(b(1),x(...e)),t.pipe(g(1))))((()=>{c.current=V(i,t),r.current=V(r.current,t)})),E((e=>[e,le(c.current,e)])),x((([t,n])=>{var o;n&&(r.current=q(r.current,l(n),(o=!0,t=>e(e({},t),{expanded:null!=o?o:!t.expanded}))));let i=r.current;n&&(i=H(i,n,e(e({},s),{children:[],dropPreview:!0,root:void 0}))),p(e(e({},I(i)),{dragSource:e(e({},s),{coord:t,children:[]}),dropTarget:n}))})),C(),y()).subscribe((t=>{"N"===t.kind&&$((n=>{let r=n;const[,i]=t.value;return i?(r=q(r,l(i),(t=>e(e({},t),{expanded:!0}))),H(r,i,s)):o(M("children"),d(e(e({},s),{coord:c.current.dragSource.coord,root:!0})),r)})),p(void 0)}))}),[r.current]),$=e=>(se.push(r.current),de=[],s(e));return t.createElement(k.Provider,{value:{canvas:r.current,setCanvas:$}},t.createElement(L.Provider,{value:{startDragging:h}},t.createElement("div",{className:"App"},t.createElement("button",{onClick:function(){const e=se.pop();e&&(de.push(r.current),s(e))}},"undo"),t.createElement("button",{onClick:function(){const e=de.pop();e&&(se.push(r.current),s(e))}},"redo"),t.createElement(ce,{canvas:null!=(n=c.current)?n:i}))))}$.render(t.createElement(t.StrictMode,null,t.createElement(ue,null)),document.getElementById("root"));
