var e=Object.assign;import{r as t,f as n,s as r,o,l as i,a as c,i as a,b as l,c as d,d as s,p as u,e as p,t as m,g as h,h as f,j as g,k as b,m as x,u as v,n as w,q as E,v as C,w as y,x as M,y as k}from"./vendor.4730c5ea.js";!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const r=new URL(e,location),o=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,i)=>{const c=new URL(e,r);if(self[t].moduleMap[c])return n(self[t].moduleMap[c]);const a=new Blob([`import * as m from '${c}';`,`${t}.moduleMap['${c}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){i(new Error(`Failed to import: ${e}`)),o(l)},onload(){n(self[t].moduleMap[c]),o(l)}});document.head.appendChild(l)})),self[t].moduleMap={}}}("/tsmind/assets/");const z=t.createContext({canvas:null,setCanvas:e=>{}});function R(t={}){const{label:n="New Node",direction:r="right"}=t;return e({root:t.root,id:Math.random().toString(36).slice(2),label:n,direction:r,expanded:!0,children:[],summaries:[]},t.root?{coord:t.coord}:{})}const $=t.createContext({startDragging:()=>{}});n(document,"mousedown");const S=n(document,"mousemove"),D=n(document,"mouseup"),N=20,P=20,B=10,Y=5,j=8,O=5;function W(e){return e.reduce(((e,t)=>{return n=e,r=t,{top:Math.min(n.top,r.top),left:Math.min(n.left,r.left),bottom:Math.max(n.bottom,r.bottom),right:Math.max(n.right,r.right)};var n,r}),{top:1/0,left:1/0,right:-1/0,bottom:-1/0})}function F(t){return e({position:"absolute",padding:`${Y}px ${B}px`,border:"1px solid black",boxSizing:"border-box",borderRadius:"5px",backgroundColor:"white"},t.fixedWidth?{maxWidth:`${t.fixedWidth}px`,width:`${t.fixedWidth}px`,overflowWrap:"break-word",whiteSpace:"break-spaces"}:{whiteSpace:"nowrap"})}const L=new WeakMap;function X(t){if(L.has(t))return L.get(t);const n=new DocumentFragment;const o=function t(r){const o=r.children.map(r.expanded?t:function t(n){return e(e({coord:[0,0]},n),{children:n.children.map(t),size:()=>[0,0]})}),i=function(e){const t=document.createElement("span");return t.setAttribute("style","visibility: hidden;"),Object.assign(t.style,F(e)),t.innerText=e.label,n.appendChild(t),t}(r);return e(e({coord:[0,0]},r),{children:o,size:()=>{const{width:e,height:t}=i.getBoundingClientRect(),n=[e,t];return i.remove(),n}})}(t);document.body.appendChild(n);const i=function t(n){const o=n.children.map(n.expanded?t:function t(n){return e(e({},n),{size:n.size(),height:0,children:n.children.map(t)})}),i=n.size(),c=Math.max(i[1],N*(o.length-1)+r(o,"height"));return e(e({},n),{size:i,height:c,children:o})}(o);return L.set(t,i),i}function A(t){const n=n=>function(t,n){function r(t){return e(e({},t),{children:t.children.map(r),summaries:[]})}return function t(o){let i=0,c={top:o.coord[1]-o.size[1]/2-j,bottom:o.coord[1]+o.size[1]/2+j,left:o.coord[0]-o.size[0]/2-j,right:o.coord[0]+o.size[0]/2+j};if(!o.expanded)return{node:e(e({},o),{children:o.children.map(r),summaries:[]}),rect:c};for(const e of o.children)e.coord=[o.coord[0]+(o.size[0]/2+P+e.size[0]/2)*("left"===n?-1:1),o.coord[1]+i-o.height/2+e.height/2],i+=e.height+N;let a=o.children.map(t),l=a.map(((t,n)=>e(e({},t.node),{summaries:o.children[n].summaries.map(((t,n)=>e(e({},t),{rect:W(a.slice(n,n+t.count).map((e=>e.rect)))})))})));return c=W([c].concat(a.map((e=>e.rect)))),{node:e(e({},o),{children:l,summaries:o.summaries.map((t=>e(e({},t),{rect:c})))}),rect:c}}(X(t)).node}(e(e({},t),{children:t.children.filter((e=>e.direction===n))}),n),r=n("right");return e(e({},r),{children:r.children.concat(n("left").children)})}function I(e){return{children:e.children.map(A)}}function T(e){return c(e,(e=>["children",e]))}function U(e){return t=T(e),[l(t),d(t)];var t}function _(e,t,n){return o(i(T(t)),n,e)}function q(e,t,n){const[r,c]=U(t);return o(i(r),a(c,n),e)}function H(e,t,n){return _(e,t,(()=>n))}function K(e,t){const[n,r]=U(t);return o(i(n),p(r,1),e)}function V(e,t){return[e[0]-t[0],e[1]-t[1]]}function G(e,t){const n=V(e,t);return Math.abs(n[0])+Math.abs(n[1])}const J=function(e,t){return[e[0]+t[0],e[1]+t[1]]};function Q(e){return`${e[0]},${e[1]}`}const Z=t.memo((function(e){const{a:n,b:r}=e,o=Math.min(n[1],r[1]),i=Math.min(n[0],r[0]),c=Math.max(Math.abs(n[0]-r[0]),1),a=Math.max(Math.abs(n[1]-r[1]),1),l=[i,o],d=[r[0]-i,n[1]-o],s=[n[0]-i,r[1]-o];return t.createElement("svg",{viewBox:`0 0 ${c} ${a}`,style:{position:"absolute",zIndex:-1,top:o,left:i,width:c,height:a}},t.createElement("path",{d:`M${Q(V(n,l))} C${Q(d)} ${Q(s)} ${Q(V(r,l))}`,fill:"transparent",stroke:"black"}))})),ee=function(e){const[n,r]=t.useState(!1);return t.createElement("span",{style:{opacity:Number(!e.expanded||n),position:"absolute",left:e.coord[0],top:e.coord[1],fontSize:"0.8rem",transform:"translate(-50%, -50%)",border:"solid 1px black",borderRadius:"1000px",width:"12px",height:"12px",backgroundColor:n?"gray":"white",lineHeight:"12px",textAlign:"center",userSelect:"none",cursor:"pointer",transition:n?"opacity .3s ease":""},onClick:e.toggle,onMouseOver:()=>r(!0),onMouseOut:()=>r(!1)},e.expanded?"-":e.count)},te=t.memo((function(e){const{parent:n}=e,{children:r}=n,o=n.root||!n.children.length?n.coord:[n.coord[0]+n.size[0]/2+10,n.coord[1]];return t.createElement(t.Fragment,null,n.root||t.createElement(t.Fragment,null,t.createElement(Z,{a:n.coord,b:o}),t.createElement(ee,{coord:o,expanded:n.expanded,count:n.children.length,toggle:e.toggle})),n.expanded&&r.map(((e,n)=>t.createElement(Z,{key:n,a:o,b:J(e.coord,[(O-e.size[0]/2)*("left"===e.direction?-1:1),0])}))))})),ne=new Set,re=t.memo((function(n){const{node:r,editing:o}=n,[i,c]=t.useState(r.label.length),a=t.useRef(null);return t.useLayoutEffect((()=>{const e=document.getSelection();if(o&&e&&a.current){const t=new Range,n=Array.from(a.current.childNodes).find((e=>e.nodeValue));n&&(null==t||t.setStart(n,i),null==t||t.setEnd(n,i),e.removeAllRanges(),e.addRange(t))}}),[i,o]),t.createElement("div",{ref:a,className:"editor",contentEditable:o,suppressContentEditableWarning:!0,onBlur:n.onBlur,onInput:t=>{var o,i;c(null!=(i=null==(o=window.getSelection())?void 0:o.getRangeAt(0).startOffset)?i:0),n.onChange(e(e({},r),{label:t.currentTarget.innerText}))}},r.label||" ")})),oe=t.memo((function(n){let{node:r,path:c,getCoord:a}=n;const[l,d]=t.useState(ne.has(r.id)),u=t.useCallback((()=>d(!1)),[]),{canvas:p,setCanvas:f}=t.useContext(z),{startDragging:g}=t.useContext($),b=t.useRef(null);function x(e){f(H(p,c,e))}function v(){const t=R({direction:r.direction});ne.add(t.id);const n=H(p,c,e(e({},r),{expanded:!0}));f(function(e,t,n){return o(i(T(t).concat("children")),s(n),e)}(n,c,t))}t.useEffect((()=>{ne.delete(r.id)}),[]),r=e(e({},r),{expanded:r.expanded||r.children.some((e=>e.dropPreview))});const[w,E]=V(r.coord,(C=r.size,y=.5,[C[0]*y,C[1]*y]));var C,y;const M=e(e({},F(r)),{display:"flex",alignItems:"center",top:E,left:w,width:r.size[0],height:r.size[1]});return t.createElement(t.Fragment,null,t.createElement(te,{parent:r,toggle:()=>{x(e(e({},r),{expanded:!r.expanded}))}}),r.expanded&&r.children.map(((e,n)=>t.createElement("div",{key:e.id,className:e.dropPreview?"drop-preview":""},e.summaries.map(((l,d)=>{const{top:s,left:u,right:p,bottom:g}=l.rect;return t.createElement("div",{key:`${e.id}-${l.count}`,style:{position:"absolute",top:`${s}px`,left:`${u}px`,width:p-u+"px",height:g-s+"px",border:"solid 2px black",boxSizing:"border-box",userSelect:"none",zIndex:-100}},t.createElement("div",{style:{position:"absolute",bottom:"-2px",height:"5px",cursor:"s-resize",width:"100%"},onMouseDown:e=>{e.stopPropagation();const t=n,l=e.target.parentElement,s=e.clientY,u=l.getBoundingClientRect().height;let p=e.clientY;S.pipe(m(D)).subscribe({next:e=>{l.style.height=`${e.clientY-s+u}px`,p=e.clientY},complete:()=>{const[,e]=a(0,p),n=Math.max(t,h((t=>t.coord[1]<=e),r.children));l.style.height=`${u}px`,f((e=>_(e,[...c,t],o(i(["summaries",d,"count"]),(()=>n-t+1)))))}})}}),l.label)})),t.createElement(oe,{getCoord:a,node:e,path:[...c,n]})))),t.createElement("div",{ref:b,className:"node-wrap node",style:M,onKeyDown:e=>{if("Enter"===e.key)if(e.preventDefault(),l)d(!1),b.current.focus();else{if(function(e){return!!e.root}(r))return v();const e=R();ne.add(e.id),f(q(p,c,e))}else"Tab"===e.key&&(e.preventDefault(),d(!1),v())},tabIndex:-1,onMouseDown:e=>{if(l)return;const t=V(r.coord,a(e.clientX,e.clientY));g(n.path,((e,n)=>J(a(e,n),t)),[e.clientX,e.clientY])},onDoubleClick:e=>{l||(e.stopPropagation(),l||d(!0))}},t.createElement("div",{className:"resizer",onMouseDown:t=>{t.stopPropagation();const n=t.clientX,o=b.current.getBoundingClientRect().width;S.pipe(m(D)).subscribe((t=>{const i=o+t.clientX-n;i<10||f((t=>H(t,c,e(e({},r),{fixedWidth:i}))))}))}}),t.createElement(re,{editing:l,node:r,onBlur:u,onChange:x})))}));function ie(e){const{canvas:n}=e,{setCanvas:r}=t.useContext(z),c=t.useRef(null),a=t.useCallback(((e,t)=>{const{left:n,top:r}=c.current.getBoundingClientRect();return[e-n-300,t-r-300]}),[]);return t.createElement("div",{ref:c,style:{width:600,height:600},onMouseDown:e=>{e.detail>1&&e.preventDefault()},onDoubleClick:e=>{e.target===c.current&&(e.preventDefault(),r(o(i(["children"]),s(R({root:!0,label:"Free Node",coord:a(e.clientX,e.clientY)})))))}},t.createElement("div",{style:{transform:"translate(300px, 300px)"}},n.children.map(((e,n)=>t.createElement(oe,{key:e.id,node:e,path:[n],getCoord:a}))),n.dragSource&&!n.dropTarget&&t.createElement(oe,{node:n.dragSource,path:[],getCoord:a})))}const ce={children:[{label:"Root",id:"root",expanded:!0,direction:"right",root:!0,coord:[0,0],summaries:[],children:[{label:"sup2",id:"sub2",direction:"right",expanded:!1,summaries:[{count:1,label:"summ"}],children:[{label:"sub4",id:"sub4",direction:"right",expanded:!1,children:[],summaries:[]},{label:"sub3",id:"sub3",direction:"right",expanded:!1,children:[],summaries:[]}]},{label:"sub5",id:"sub5",direction:"right",expanded:!1,children:[],summaries:[]},{label:"sub1",id:"sub1",direction:"left",expanded:!1,children:[],summaries:[]}]}]};function ae(e,t){let n={value:-1/0,path:void 0};function r(e,o){const i=function(e,t){return-G(t,e.coord)}(e,t);i>n.value&&t[0]-e.coord[0]>P&&t[0]-e.coord[0]<100&&(n={value:i,path:[...o,0]}),e.children.filter((e=>!e.dropPreview)).forEach(((e,t)=>r(e,[...o,t])))}return e.children.filter((e=>!e.dropPreview)).forEach(((e,t)=>r(e,[t]))),n.path}let le=[],de=[];function se(){var n;const r=t.useRef(ce),i=t.useMemo((()=>I(r.current)),[r.current]),c=t.useRef(),a=v();function d(e){r.current="function"==typeof e?e(r.current):e,a()}function p(e){c.current=e,a()}const h=t.useCallback(((t,n,a)=>{const d=function(e,t){return u(T(t),e)}(i,t);S.pipe(m(D),w((e=>G([e.clientX,e.clientY],a)<10)),E((e=>n(e.clientX,e.clientY)))).pipe(((...e)=>t=>f(t.pipe(b(1),x(...e)),t.pipe(g(1))))((()=>{c.current=K(i,t),r.current=K(r.current,t)})),E((e=>[e,ae(c.current,e)])),x((([t,n])=>{var o;n&&(r.current=_(r.current,l(n),(o=!0,t=>e(e({},t),{expanded:null!=o?o:!t.expanded}))));let i=r.current;n&&(i=q(i,n,e(e({},d),{children:[],dropPreview:!0,root:void 0}))),p(e(e({},I(i)),{dragSource:e(e({},d),{coord:t,children:[]}),dropTarget:n}))})),C(),y()).subscribe((t=>{"N"===t.kind&&k((n=>{let r=n;const[,i]=t.value;return i?(r=_(r,l(i),(t=>e(e({},t),{expanded:!0}))),q(r,i,d)):o(M("children"),s(e(e({},d),{coord:c.current.dragSource.coord,root:!0})),r)})),p(void 0)}))}),[r.current]),k=e=>(le.push(r.current),de=[],d(e));return t.createElement(z.Provider,{value:{canvas:r.current,setCanvas:k}},t.createElement($.Provider,{value:{startDragging:h}},t.createElement("div",{className:"App"},t.createElement("button",{onClick:function(){const e=le.pop();e&&(de.push(r.current),d(e))}},"undo"),t.createElement("button",{onClick:function(){const e=de.pop();e&&(le.push(r.current),d(e))}},"redo"),t.createElement(ie,{canvas:null!=(n=c.current)?n:i}))))}k.render(t.createElement(t.StrictMode,null,t.createElement(se,null)),document.getElementById("root"));
