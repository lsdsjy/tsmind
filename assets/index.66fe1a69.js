var e=Object.assign;import{r as t,s as n,o as r,l as o,i,f as c,a,b as l,c as s,p as d,d as u,e as h,g as p,h as m,j as f,t as g,k as b,u as v,m as E,n as x,q as C,v as w,w as y,x as M,y as $,z as k,A as R}from"./vendor.3a7cac0f.js";!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const r=new URL(e,location),o=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,i)=>{const c=new URL(e,r);if(self[t].moduleMap[c])return n(self[t].moduleMap[c]);const a=new Blob([`import * as m from '${c}';`,`${t}.moduleMap['${c}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){i(new Error(`Failed to import: ${e}`)),o(l)},onload(){n(self[t].moduleMap[c]),o(l)}});document.head.appendChild(l)})),self[t].moduleMap={}}}("/tsmind/assets/");const S=t.createContext({canvas:null,setCanvas:e=>{}}),z=t.createContext({startDragging:()=>{}}),j=20,B=20,D=10,L=5,P=5;function A(e){return{padding:`${L}px ${D}px`}}function N(t){const r=new DocumentFragment;function o(e){const t=document.createElement("span");return t.setAttribute("style",`position: absolute; visibility: hidden; user-select: none; ${Object.entries(A()).map((([e,t])=>`${e}: ${t}`)).join(";")}`),t.innerText=e.label,r.appendChild(t),t}const i=function t(n){const r=n.children.map(t),i=o(n);return e(e({coord:[0,0]},n),{children:r,size:()=>{const e=[i.clientWidth,i.clientHeight];return i.remove(),e}})}(t);return document.body.appendChild(r),function t(r){const o=r.children.map(t),i=r.size(),c=Math.max(i[1],j*(o.length-1)+n(o,"height"));return e(e({},r),{size:i,height:c,children:o})}(i)}function O(t){const n=n=>function(t,n){return function t(r){let o=0;for(const e of r.children)e.coord=[r.coord[0]+(r.size[0]/2+B+e.size[0]/2)*("left"===n?-1:1),r.coord[1]+o-r.height/2+e.height/2],o+=e.height+j;return e(e({},r),{children:r.children.map(t)})}(N(t))}(e(e({},t),{children:t.children.filter((e=>e.direction===n))}),n),r=n("right");return e(e({},r),{children:r.children.concat(n("left").children)})}function U(e){return{children:e.children.map(O)}}function T(e,t=!1,n=""){return{root:t,id:Math.random().toString(36).slice(2),label:n,direction:e,expanded:!0,children:[]}}function F(e){return c(e,(e=>["children",e]))}function I(e){return t=F(e),[a(t),l(t)];var t}function X(e,t,n){const[c,a]=I(t);return r(o(c),i(a,n),e)}function Y(e,t){const[n,i]=I(t);return r(o(n),u(i,1),e)}function _(e,t){return[e[0]-t[0],e[1]-t[1]]}function H(e,t){const n=_(e,t);return Math.abs(n[0])+Math.abs(n[1])}const K=function(e,t){return[e[0]+t[0],e[1]+t[1]]};function W(e){return`${e[0]},${e[1]}`}const q=t.memo((function(e){const{a:n,b:r}=e,o=Math.min(n[1],r[1]),i=Math.min(n[0],r[0]),c=Math.max(Math.abs(n[0]-r[0]),1),a=Math.max(Math.abs(n[1]-r[1]),1),l=[i,o],s=[r[0]-i,n[1]-o],d=[n[0]-i,r[1]-o];return t.createElement("svg",{viewBox:`0 0 ${c} ${a}`,style:{position:"absolute",zIndex:-1,top:o,left:i,width:c,height:a}},t.createElement("path",{d:`M${W(_(n,l))} C${W(s)} ${W(d)} ${W(_(r,l))}`,fill:"transparent",stroke:"black"}))})),V=t.memo((function(e){const{parent:n,child:r}=e;return t.createElement(q,{a:n.coord,b:K(r.coord,[(P-r.size[0]/2)*("left"===r.direction?-1:1),0])})})),G=new Set,J=t.memo((function(n){const{node:r,editing:o}=n,[i,c]=t.useState(r.label.length),a=t.useRef(null),l=e(e({},A()),{height:r.size[1],border:"1px solid black",borderRadius:"5px",lineHeight:`${r.size[1]}px`,backgroundColor:"white"});return t.useLayoutEffect((()=>{const e=document.getSelection();if(o&&e&&a.current){const t=new Range,n=Array.from(a.current.childNodes).find((e=>e.nodeValue));n&&(null==t||t.setStart(n,i),null==t||t.setEnd(n,i),e.removeAllRanges(),e.addRange(t))}}),[i,o]),t.createElement("div",{ref:a,className:"node",contentEditable:o,style:l,suppressContentEditableWarning:!0,onBlur:n.onBlur,onInput:t=>{var o,i;c(null!=(i=null==(o=window.getSelection())?void 0:o.getRangeAt(0).startOffset)?i:0),n.onChange(e(e({},r),{label:t.currentTarget.innerText}))}},r.label||" ")})),Q=t.memo((function(e){const{node:n,path:i,getCoord:c}=e,[a,l]=t.useState(G.has(n.id)),d=t.useCallback((()=>l(!1)),[]),{canvas:u,setCanvas:p}=t.useContext(S),{startDragging:m}=t.useContext(z);function f(){const e=T(n.direction);G.add(e.id),p(function(e,t,n){return r(o(F(t).concat("children")),s(n),e)}(u,i,e))}t.useEffect((()=>{G.delete(n.id)}),[]);const[g,b]=[n.coord[0]-n.size[0]/2,n.coord[1]-n.size[1]/2];return t.createElement(t.Fragment,null,n.children.map(((e,r)=>t.createElement("div",{key:e.id,className:e.dropPreview?"drop-preview":""},t.createElement(V,{parent:n,child:e}),t.createElement(Q,{getCoord:c,node:e,path:[...i,r]})))),t.createElement("div",{className:"node-wrap",style:{position:"absolute",top:b,left:g},onKeyPressCapture:e=>{if("Enter"===e.key)if(e.preventDefault(),a)l(!1);else if(e.shiftKey)f();else{if(function(e){return!!e.root}(n))return;const e=T(n.direction);G.add(e.id),p(X(u,i,e))}},tabIndex:-1,onMouseDown:t=>{const r=_(n.coord,c(t.clientX,t.clientY));m(e.path,((e,t)=>K(c(e,t),r)),[t.clientX,t.clientY])},onDoubleClick:()=>{a||l(!0)}},t.createElement(J,{editing:a,node:n,onBlur:d,onChange:function(e){p(h(i,e,u))}})))}));function Z(e){const{canvas:n}=e,r=t.useRef(null),o=t.useCallback(((e,t)=>{const{left:n,top:o}=r.current.getBoundingClientRect();return[e-n-300,t-o-300]}),[]);return t.createElement("div",{ref:r,style:{width:600,height:600}},t.createElement("div",{style:{transform:"translate(300px, 300px)"}},n.children.map(((e,n)=>t.createElement(Q,{key:e.id,node:e,path:[n],getCoord:o}))),n.dragSource&&!n.dropTarget&&t.createElement(Q,{node:n.dragSource,path:[],getCoord:o})))}const ee={children:[{label:"Root",id:"root",expanded:!0,direction:"right",root:!0,coord:[0,0],children:[{label:"sup2",id:"sub2",direction:"right",expanded:!1,children:[{label:"sub4",id:"sub4",direction:"right",expanded:!1,children:[]},{label:"sub3",id:"sub3",direction:"right",expanded:!1,children:[]}]},{label:"sub5",id:"sub5",direction:"right",expanded:!1,children:[]},{label:"sub1",id:"sub1",direction:"left",expanded:!1,children:[]}]}]};function te(e,t){let n={value:-1/0,path:void 0};function r(e,o){const i=function(e,t){return-H(t,e.coord)}(e,t);i>n.value&&t[0]-e.coord[0]>B&&t[0]-e.coord[0]<100&&(n={value:i,path:[...o,0]}),e.children.filter((e=>!e.dropPreview)).forEach(((e,t)=>r(e,[...o,t])))}return e.children.forEach(((e,t)=>r(e,[t]))),n.path}const ne=b(document,"mousemove"),re=b(document,"mouseup");let oe,ie=[],ce=[];function ae(){const[n,o]=t.useState(ee),i=t.useMemo((()=>U(n)),[n]),c=v();function a(e){oe=e,c()}const l=t.useCallback(((t,c,l)=>{const u=function(e,t){return d(F(t),e)}(i,t),b=ne.pipe(E(re),x((e=>H([e.clientX,e.clientY],l)<10)),((...e)=>t=>p(t.pipe(f(),g(...e)),t.pipe(m(1))))((()=>{a(e(e({},i),{dragSource:e(e({},u),{children:[]})}))})),C((e=>c(e.clientX,e.clientY))));b.subscribe((e=>{a(h(["dragSource","coord"],e,oe))})),b.pipe(C((e=>te(oe,e))),w(((e,t)=>k(e,t))),g((r=>{let o=Y(n,t);r&&(o=X(o,r,e(e({},u),{children:[],dropPreview:!0,root:void 0}))),a(e(e(e({},oe),U(o)),{dropTarget:r}))})),y(),M()).subscribe((n=>{"N"===n.kind&&o((o=>{const i=Y(o,t),c=n.value;return c?X(i,c,u):r($("children"),s(e(e({},oe.dragSource),{root:!0})),i)})),a(void 0)}))}),[n]);return t.createElement(S.Provider,{value:{canvas:n,setCanvas:function(e){return ie.push(n),ce=[],o(e)}}},t.createElement(z.Provider,{value:{startDragging:l}},t.createElement("div",{className:"App"},t.createElement("button",{onClick:function(){const e=ie.pop();e&&(ce.push(n),o(e))}},"undo"),t.createElement("button",{onClick:function(){const e=ce.pop();e&&(ie.push(n),o(e))}},"redo"),t.createElement(Z,{canvas:null!=oe?oe:i}))))}R.render(t.createElement(t.StrictMode,null,t.createElement(ae,null)),document.getElementById("root"));
